

<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Using one carrierwave image uploader with dynamic versions</title>

  
    <meta name="description" content="How to manage models with different image versions with only one image uploader">
  

  <meta name="author" content="Diowa">

  <meta content="#fff" name="theme-color">

  <link rel="canonical" href="http://www.diowa.com/blog/rails/2014/03/22/using-one-carrierwave-image-uploader-with-dynamic-versions">

  <link rel="stylesheet" type="text/css" href="/assets/application-78a3e4752264a86b7b7d484506ce0f09bd034160d413b054a56567caba5c7da4.css">
  <link href="https://netdna.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700%7COswald:300" rel="stylesheet" type="text/css" media="all">

  <!-- HTML5 shim IE8 support of HTML5 elements -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
  <![endif]-->

  <meta content="diowa" property="og:site_name">
<meta content="Using one carrierwave image uploader with dynamic versions" property="og:title">
<meta content="article" property="og:type">
<meta content="How to manage models with different image versions with only one image uploader" property="og:description">


<meta content="http://www.diowa.com/blog/rails/2014/03/22/using-one-carrierwave-image-uploader-with-dynamic-versions" property="og:url">



<meta content="2014-03-22T00:00:00+01:00" property="article:published_time">



<meta content="geremia.taglialatela" property="article:author">



<meta content="/assets/diowa-open-graph-b0adb7f74230dfa8bec7f809819b3550b2d6027a60fba6ff0c02d5967f23976f.jpg" property="og:image">



  
  <meta content="Rails" property="article:section">
  



  
  <meta content="carrierwave" property="article:tag">
  
  <meta content="dynamic image versions" property="article:tag">
  
  <meta content="custom image processing" property="article:tag">
  



  <link href="https://plus.google.com/+GeremiaTaglialatela" rel="author">



  <!-- Favicons -->
  <link rel="apple-touch-icon" href="/assets/diowa-touch-icon-43b4cd7ea6b37652e51fff2e780837a5bc2532b4e77879a7f15a4d4d36d242f4.png" size="144x144">
  <link rel="icon" href="/assets/diowa-touch-icon-43b4cd7ea6b37652e51fff2e780837a5bc2532b4e77879a7f15a4d4d36d242f4.png" size="144x144">

  <!-- atom & rss feed -->
  <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
  <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">
</head>


  <body>
    <nav class="navbar navbar-default" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#navbar-responsive-collapse" aria-expanded="false">
        <span class="sr-only"></span>
        <span class="icon-bar icon-bar--top"></span>
        <span class="icon-bar icon-bar--middle"></span>
        <span class="icon-bar icon-bar--bottom"></span>
      </button>
      <a class="navbar-brand" href="/"><img alt="diowa" src="/assets/diowa-569bda59a493ab6b6d0edf5b3b6c55b585cfa9f56320bbaf1c2dd8ab6baea228.png" height="32" width="100"/></a>
    </div>
    <div class="navbar-collapse collapse" id="navbar-responsive-collapse">
      <ul class="nav navbar-nav navbar-right">
      
        <li class="active"><a href="/blog/" class="active">Blog</a></li>
      
      
        
        


  
    
      
        
        <li><a href="/about">About</a></li>
        
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
        
        <li><a href="/contact">Contact</a></li>
        
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
  
    
      
    
  
    
      
    
  
    
  
    
      
    
  




      </ul>
    </div>
  </div>
</nav>


    


<div class="container">
  <article>
    <div class="page-header">
      <h1>Using one carrierwave image uploader with dynamic versions <small></small></h1>
      <p class="text-muted">
        Posted by <b>Geremia Taglialatela</b>
        on <b>22 March 2014</b>
      </p>
    </div>
    <div class="content">
      
<p>I was looking for a cleaner approach to manage models with different image versions. I came into <a href="http://andreapavoni.com/blog/2012/3/using-one-carrierwave-image-uploader-with-different-sizes-on-several-models">this awesome blog post</a> by <a href="http://andreapavoni.com/">Andrea Pavoni</a>. I needed multiple, configurable processes so I extended and updated his excellent work.</p>

<!--more-->

<h3 id="update-november-1st-2014">Update! November, 1st 2014</h3>
<p>Improved the code with an initializer. This fixes an edge case with Rails Admin (versions are not created when validations fails). Now we will not pollute models with image versions and we can use the same versions for multiple models but there is a little bit of separation as a drawback.</p>

<p>We also improved the image uploader in order to provide progressive jpegs.</p>

<h4 id="image_versions_rb-initializer">image_versions_.rb (initializer)</h4>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">APP_IMAGE_VERSIONS</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">asset: </span><span class="p">{</span>
    <span class="ss">fill_1200x518: </span><span class="p">{</span>
      <span class="ss">resize_to_fill: </span><span class="p">[</span><span class="mi">1200</span><span class="p">,</span> <span class="mi">518</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="ss">black_and_white: </span><span class="p">{</span>
      <span class="ss">resize_to_limit: </span><span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">],</span>
      <span class="ss">desaturate: </span><span class="kp">nil</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="ss">gallery: </span><span class="p">{</span>
    <span class="ss">fill_800x600: </span><span class="p">{</span>
      <span class="ss">resize_to_fill: </span><span class="p">[</span><span class="mi">800</span><span class="p">,</span> <span class="mi">600</span><span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="no">APP_ALL_IMAGE_VERSIONS</span> <span class="o">=</span> <span class="no">APP_IMAGE_VERSIONS</span><span class="p">.</span><span class="nf">map</span><span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span><span class="p">.</span><span class="nf">keys</span> <span class="p">}.</span><span class="nf">flatten</span><span class="p">.</span><span class="nf">uniq</span></code></pre></figure>

<h4 id="slideshow_imagerb">slideshow_image.rb</h4>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">SlideshowImage</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>

  <span class="no">IMAGE_VERSIONS</span> <span class="o">=</span> <span class="no">APP_IMAGE_VERSIONS</span><span class="p">[</span><span class="ss">:asset</span><span class="p">]</span>
  <span class="n">mount_uploader</span> <span class="ss">:image</span><span class="p">,</span> <span class="no">ImageUploader</span>

<span class="k">end</span></code></pre></figure>

<h4 id="image_uploaderrb">image_uploader.rb</h4>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">ImageUploader</span> <span class="o">&lt;</span> <span class="no">CarrierWave</span><span class="o">::</span><span class="no">Uploader</span><span class="o">::</span><span class="no">Base</span>
  <span class="kp">include</span> <span class="no">CarrierWave</span><span class="o">::</span><span class="no">MiniMagick</span>

  <span class="n">storage</span> <span class="ss">:file</span>

  <span class="k">def</span> <span class="nf">store_dir</span>
    <span class="s2">"uploads/</span><span class="si">#{</span><span class="n">model</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">to_s</span><span class="p">.</span><span class="nf">underscore</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">mounted_as</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">model</span><span class="p">.</span><span class="nf">id</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>

  <span class="n">process</span> <span class="ss">resize_to_limit: </span><span class="p">[</span><span class="mi">2048</span><span class="p">,</span> <span class="mi">2048</span><span class="p">]</span>
  <span class="n">process</span> <span class="ss">:optimize</span>

  <span class="c1"># better to always have a thumbnail version because it is used by Rails Admin</span>
  <span class="n">version</span> <span class="ss">:thumbnail</span> <span class="k">do</span>
    <span class="n">process</span> <span class="ss">resize_to_fit: </span><span class="p">[</span><span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="p">]</span>
  <span class="k">end</span>

  <span class="no">APP_ALL_IMAGE_VERSIONS</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span>
    <span class="n">version</span> <span class="n">v</span><span class="p">,</span> <span class="ss">if: </span><span class="o">-&gt;</span> <span class="p">(</span><span class="n">uploader</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span> <span class="p">{</span> <span class="n">uploader</span><span class="p">.</span><span class="nf">model</span><span class="p">.</span><span class="nf">class</span><span class="o">::</span><span class="no">IMAGE_VERSIONS</span><span class="p">.</span><span class="nf">has_key?</span><span class="p">(</span><span class="n">opts</span><span class="p">[</span><span class="ss">:version</span><span class="p">])</span> <span class="p">}</span> <span class="k">do</span>
      <span class="n">process</span> <span class="ss">dynamic_version: </span><span class="n">v</span>
      <span class="n">process</span> <span class="ss">:optimize</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">dynamic_version</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
    <span class="n">model</span><span class="p">.</span><span class="nf">class</span><span class="o">::</span><span class="no">IMAGE_VERSIONS</span><span class="p">[</span><span class="n">version</span><span class="p">].</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="nb">method</span><span class="p">,</span> <span class="n">args</span><span class="o">|</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">send</span> <span class="nb">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="c1"># Note: this process requires a recent version of ImageMagick</span>
  <span class="k">def</span> <span class="nf">desaturate</span>
    <span class="n">manipulate!</span> <span class="k">do</span> <span class="o">|</span><span class="n">img</span><span class="o">|</span>
      <span class="n">img</span><span class="p">.</span><span class="nf">colorspace</span><span class="p">(</span><span class="s1">'Gray'</span><span class="p">)</span>
      <span class="n">img</span><span class="p">.</span><span class="nf">brightness_contrast</span><span class="p">(</span><span class="s1">'20x0'</span><span class="p">)</span>
      <span class="n">img</span> <span class="o">=</span> <span class="k">yield</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="k">if</span> <span class="nb">block_given?</span>
      <span class="n">img</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">optimize</span>
    <span class="n">manipulate!</span> <span class="k">do</span> <span class="o">|</span><span class="n">img</span><span class="o">|</span>
      <span class="n">img</span><span class="p">.</span><span class="nf">combine_options</span> <span class="k">do</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>
        <span class="n">c</span><span class="p">.</span><span class="nf">strip</span>
        <span class="n">c</span><span class="p">.</span><span class="nf">quality</span> <span class="s1">'85'</span>
        <span class="n">c</span><span class="p">.</span><span class="nf">depth</span> <span class="s1">'8'</span>
        <span class="n">c</span><span class="p">.</span><span class="nf">interlace</span> <span class="s1">'Line'</span>
      <span class="k">end</span>
      <span class="n">img</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">extension_white_list</span>
    <span class="sx">%w(jpg jpeg gif png)</span>
  <span class="k">end</span>

  <span class="c1"># Override the filename of the uploaded files:</span>
  <span class="c1"># Avoid using model.id or version_name here, see uploader/store.rb for details.</span>
  <span class="c1"># def filename</span>
  <span class="c1">#   "something.jpg" if original_filename</span>
  <span class="c1"># end</span>
<span class="k">end</span></code></pre></figure>

<p>Suggestions to improve this are always appreciated!</p>

    </div>
  </article>
  <hr>


  <ul class="list-inline">
    <li>Categories:</li>
    
    


  
    
      <li><a href="/blog/categories.html#Rails-ref">
        Rails
        (<span>2</span>)
      </a></li>
    
  



  </ul>


  <ul class="list-inline">
    <li>Tags:</li>
    
    


  
    
      <li><a href="/blog/tags.html#carrierwave-ref">carrierwave (<span>1</span>)</a></li>
    
      <li><a href="/blog/tags.html#dynamic image versions-ref">dynamic image versions (<span>1</span>)</a></li>
    
      <li><a href="/blog/tags.html#custom image processing-ref">custom image processing (<span>1</span>)</a></li>
    
  



  </ul>

  <ul class="pager hidden-print">
  
    <li class="previous"><a href="/blog/productivity/2014/01/24/print-merge-on-google-drive" title="Print merge on Google Drive with autoCrat">&larr; Previous</a></li>
  
    <!--<li><a href="/blog/archive.html">Archive</a></li>-->
  
    <li class="next"><a href="/blog/heroku/2016/02/26/using-rgeo-with-geos-on-heroku" title="Using RGeo with GEOS on Heroku">Next &rarr;</a></li>
  
  </ul>
  <ul class="nav nav-justified nav-blog hidden-print">
  
  
  


  
    
      
    
  
    
      
        
        <li><a href="/blog/archive"><span class="fa fa-archive"></span> Archive</a></li>
        
      
    
  
    
      
    
  
    
      
        
        <li><a href="/blog/categories"><span class="fa fa-folder-open"></span> Categories</a></li>
        
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
  
    
      
    
  
    
      
    
  
    
  
    
      
        
        <li><a href="/blog/tags"><span class="fa fa-tags"></span> Tags</a></li>
        
      
    
  




</ul>

  


  <div id="disqus_thread" class="hidden-print"></div>
<script type="text/javascript">
    
    var disqus_shortname = 'diowa'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>





</div>



    <footer>
  <div class="footer-wrapper">
    <img src="/assets/diowa-footer-285e6f3dc582358bcc50309309e5a28fd2e070a7aa883a13c700e100b891d712.png" width="56" height="64" alt="diowa" class="footer-logo">
    <div class="container">
      <ul class="list-inline pull-right">
        
          <li><a href="/blog/">Blog</a></li>
        
        
        
        


  
    
      
        
        <li><a href="/about">About</a></li>
        
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
        
        <li><a href="/contact">Contact</a></li>
        
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
  
    
      
    
  
    
      
    
  
    
  
    
      
    
  




      </ul>
      <ul class="list-inline">
        <li>&copy; diowa 2018</li>
      </ul>
    </div>
  </div>
</footer>
<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
<script async="" type="text/javascript" src="/assets/application-cdb9a8c5f535b6bcc2dbd71f7a29d680698c39f9437754b07fc4d40011943c4b.js"></script>



  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-39283101-1', 'diowa.com');
  ga('send', 'pageview');

</script>





<!-- Respond.js IE8 support of media queries -->
<!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->

  </body>
</html>

